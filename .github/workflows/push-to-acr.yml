name: Build and Push Docker Image to ACR (Multi-Env)

on:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        description: "Select Environment"
        options: [Dev, QA, Staging, Prod]

env:
  IMAGE_NAME: message-app

jobs:
  build-and-push:
    runs-on: ubuntu-22.04

    steps:
      # Step 1: Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Map environment input to lowercase
      - name: Set environment variable
        run: echo "ENV=${{ github.event.inputs.environment }}" | tr '[:upper:]' '[:lower:]' >> $GITHUB_ENV

      # Step 3: Load ACR credentials dynamically based on ENV
      - name: Load ACR Credentials
        run: |
          echo "ACR_LOGIN_SERVER=${{ secrets['ACR_' + github.event.inputs.environment + '_LOGIN_SERVER'] }}" >> $GITHUB_ENV
          echo "ACR_USERNAME=${{ secrets['ACR_' + github.event.inputs.environment + '_USERNAME'] }}" >> $GITHUB_ENV
          echo "ACR_PASSWORD=${{ secrets['ACR_' + github.event.inputs.environment + '_PASSWORD'] }}" >> $GITHUB_ENV

      # Step 4: Login to correct ACR
      - name: Login to ACR
        uses: docker/login-action@v2
        with:
          registry: ${{ env.ACR_LOGIN_SERVER }}
          username: ${{ env.ACR_USERNAME }}
          password: ${{ env.ACR_PASSWORD }}

      # Step 5: Build Docker Image
      - name: Build Docker Image
        run: |
          SHORT_SHA=$(echo "${GITHUB_SHA}" | cut -c1-8)
          VERSION_TAG="v1-${SHORT_SHA}"
          docker build -t $ACR_LOGIN_SERVER/$IMAGE_NAME:$VERSION_TAG .

      # Step 6: Push Docker Image
      - name: Push Docker Image
        run: |
          SHORT_SHA=$(echo "${GITHUB_SHA}" | cut -c1-8)
          VERSION_TAG="v1-${SHORT_SHA}"
          docker push $ACR_LOGIN_SERVER/$IMAGE_NAME:$VERSION_TAG
